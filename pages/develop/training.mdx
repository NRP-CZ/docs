# InstallFest NRP Invenio

C칤le 코kolen칤:

* Nainstalovat si invenio
* Vytvo콏it nov칳 model
* Sezn치mit se s cmdline n치stroji
* Sezn치mit se s UI konfigurac칤

Nebudeme dnes 콏e코it:

* Napojen칤 na AAI
* Harvestov치n칤 do/z repozit치콏e
* Konfiguraci pro produk캜n칤 nasazen칤

## 칔vod

TODO: prezentace

## Prerekvizity

Invenio pro sv콢j b캩h pot콏ebuje posix syst칠m (linux, macos) a n캩kolik z치vislost칤.
Je pot콏eba m칤t nainstalovan칠 z치vislosti z [Getting started](/get_started).
TODO: update get_started.mdx

## Instalace

Instalaci zaji코콘uje skript `nrp-installer.sh`, kter칳 st치hnete z githubu a spust칤te s n치zvem repozit치콏e, kter칳 chcete vytvo콏it. `rdm-12` je aktu치ln칤 v캩tev podporovan칠 verze Invenio. Na konci Q3 se o캜ek치v치 vyd치n칤 Invenio RDM 13, v코echny oborov칠 repozit치콏e by pak m캩ly za캜칤nat s touto verz칤.

```bash
cd demo

curl -sSL https://raw.githubusercontent.com/oarepo/nrp-devtools/rdm-12/nrp-installer.sh >nrp-installer.sh
```

```bash
export REPO=$PWD/my-repo

bash nrp-installer.sh $REPO
```

TODO: do generic parameters prihodit support contact? (co se zobrazuje ve footeru?)

```
游꿗 Human readable name of the repository
   Demo repository
游꿗 Description of the repository
    (Finish with 'Alt+Enter' or 'Esc then Enter')
> My Demo Repository
 
游꿗 List of languages to use in the repository,
2 letter code separated by either comma or space
   cs de

...

Your repository is now initialized. 

To test it out, start the repository in development mode
via ./nrp develop and head to https://127.0.0.1:5000/
to check that everything has been installed correctly.

Then add metadata models via ./nrp model create <model_name>,
edit the model and compile it via ./nrp model compile <model_name>.

To generate a default UI for the model, run ./nrp ui detail <model_name>.
```

## Prvn칤 kompilace a spu코t캩n칤

```bash
cd $REPO

./nrp develop

```

```

Development server is running

1 or server     - restart python server
2 or ui         - restart webpack server
0 or stop       - stop the server (Ctrl-C also works)

```

### Kontrola

Otev콏ete prohl칤쬰캜 a zadejte adresu `https://127.0.0.1:5000/`. M캩li byste vid캩t hlavn칤 str치nku repozit치콏e.

## Import po캜치te캜n칤ch slovn칤k콢 a dat

Nechte server b캩쬰t a v nov칠m termin치lu spus콘te:

```bash
REPO=....

cd $REPO
source .venv/bin/activate
invenio oarepo fixtures load ./fixtures --verbose
```

V prohl칤쬰캜i klikn캩te na `Communities` a ujist캩te se, 쬰 je tam komunita `Generic`.

## Vytvo콏en칤 u쬴vatele

Poj캞me vytvo콏it u쬴vatele, kter칳 bude vlastn칤kem komunity `Generic`. N치sleduj칤c칤 p콏칤kaz bude cht칤t zad치n칤 hesla nov칠ho u쬴vatele, je t콏eba zadat alespo켿 6 znak콢.

```bash
invenio users create -a -c "spravce@e-infra.cz" --profile '{"full_name": "Velk칳 Spr치vce"}'

invenio access allow administration-access user spravce@e-infra.cz

invenio access allow administration-moderation user spravce@e-infra.cz
```

```bash
invenio oarepo communities members add generic "spravce@e-infra.cz" owner
```

A n치sledn캩 vytvo콏te u쬴vatele `clen@e-infra.cz` a nastavte mu roli "member" ve stejn칠 komunit캩.

### Kontrola

P콏ihlaste se do repozit치콏e jako spr치vce. M캩li byste vid캩t v menu polo쬶u `Communities` a v nich mo쬹ost vytv치콏et nov칠 komunity. Jako 캜len tla캜칤tko pro vytvo콏en칤 komunity neuvid칤te.

## Konfigurace UI - Branding

Nyn칤 je mo쬹칠 p콏izp콢sobit z치kladn칤 UI repozit치콏e formou nastaven칤 loga, v칳m캩ny text콢 a barevnosti.

Detailn캩j코칤 dokumentace je k dispozici pod sekci [Branding](https://nrp-cz.github.io/docs/customize/branding/styling)

### Nastaven칤 loga

* St치hneme si nov칠 logo z [training-assets](./training-assets/my-logo.svg).

* Pou쬴jeme n치sleduj칤c칤 postup:
<https://nrp-cz.github.io/docs/customize/branding/logo>

* Aby se zm캩ny projevily, je t콏eba restartovat development server

```
0 or stop
./nrp develop
```

### Zm캩na barevnosti

a. V ui/branding/semantic-ui/less/globals/site.variables
zm캩na pozad칤 z치hlav칤
@navbar_background_image: linear-gradient(12deg, blue, blue 15%, #ffcc00);
zm캩na prim치rn칤ch barev (pou쮂셨an칳ch pro tla캜칤tka)
@primaryColor: 'blue';

b. zm캩na barvy pozad칤 z치pat칤
ui/branding/semantic-ui/less/default/views/page_footer.variables
@pageFooterBackgroundColor: @pink;


## P콏id치n칤 modelu

V jednom NRP repozit치콏i je mo쬹o m칤t v칤ce typ콢 z치znam콢, ka쬯칳 typ s jinou mno쬴nou metadat. P콏칤kladem je kombinovan칳 repozit치콏, kde jsou z치znamy o datasetech, publikac칤ch a projektech - ka쬯칳 typ z치znamu m치 jinou strukturu metadat.

Definice typu z치znamu se naz칳v치 model. Model se skl치d치 z n치zvu, popisu, struktury metadat a syst칠mov칳ch informac칤, kter칠 jsou pou쬴ty k vygenerov치n칤 k칩du Invenio repozit치콏e. Struktura metadat je definov치na v notaci odvozen칠 od JSON sch칠matu a m콢쬰 obsahovat valida캜n칤 pravidla, popisy a dal코칤 informace.

**Pozor: p콏ed vytv치콏en칤m modelu je nutno zastavit repozit치콏, proto쬰 modelov칳 k칩d se generuje do zdrojov칳ch soubor콢 a ty nemohou b칳t zm캩n캩ny za b캩hu.**

### Vytvo콏en칤 modelu

```bash
./nrp model create datasets
```

Tento p콏칤kaz vytvo콏칤 nov칳 model s n치zvem `datasets` a vygeneruje k n캩mu i pr치zdn칠 u쬴vatelsk칠 rozhran칤.

Pozn치mka: A bude p콏ipraven CCMM (Czech Core Metadata Model), tento krok bude zahrnovat i rozhodnut칤, jestli model bude odvozen od CCMM nebo bude kompletn캩 vlastn칤.

Vygenerovan치 struktura modelu je ulo쬰na v adres치콏i `./models` v souborech `datasets.yaml` a `datasets-metadata.yaml`. YAML form치t je zvolen pro jednoduchost editace, 캜itelnost a mo쬹ost p콏id치vat pozn치mky / koment치콏e.

### Kompilace modelu

J치dro invenia neum칤 pracovat s takto definovan칳m modelem. Je t콏eba jej zkompilovat do python zdrojov칠ho
k칩du, kter칳 bude obsahovat t콏칤dy a metody pro pr치ci s modelem.

```bash
./nrp model compile datasets
```

### Datab치zov치 migrace

Invenio pou쮂셨치 postgresql datab치zi. Pro nov칳 model je t콏eba vytvo콏it n캩kolik datab치zov칳ch tabulek, kter칠 budou obsahovat data z치znam콢. Tento krok se naz칳v치 datab치zov치 migrace.

Invenio pro datab치zov칠 migrace pou쮂셨치 n치stroj alembic. Pro vytvo콏en칤 migrace je t콏eba spustit n치sleduj칤c칤 p콏칤kaz:

```bash
./nrp alembic
```

Tento p콏칤kaz provede n캩kolik krok콢:

1. `invenio alembic upgrade heads` - zaktualizuje datab치zi podle aktu치ln칤ch alembic skript콢
2. `invenio alembic revision` - porovn치 zdrojov칳 k칩d s aktu치ln칤m datab치zov칳m schematem a vygeneruje nov칳 alembic skript
3. Alembic n치stroj nen칤 dokonal칳 a vygenerovan칳 skript nen칤 funk캜n칤 - `./nrp alembic` se jej pokus칤 opravit
4. `invenio alembic upgrade heads` - aplikuje zm캩ny do datab치ze

Pokud by krok 4 nepro코el, je t콏eba zkontrolovat vygenerovan칳 alembic skript a opravit jej ru캜n캩 a n치sledn캩 zavolat `invenio alembic upgrade heads`.

### Zaveden칤 nov칠ho indexu

Invenio pou쮂셨치 Opensearch pro vyhled치v치n칤. Pro nov칳 model je t콏eba vytvo콏it nov칳 index, kter칳 bude obsahovat data z치znam콢 tohoto modelu.

```bash
invenio oarepo index init
invenio oarepo cf init
```

### Kontrola

Spust칤me op캩t server

```bash
./nrp develop
```

V pr콢b캩hu spou코t캩n칤 bude detekov치no, 쬰 se zm캩nilo prost콏ed칤 pythonu a bude provedena aktualizace instalovan칳ch knihoven a nov치 kompilace u쬴vatelsk칠ho rozhran칤. Po dokon캜en칤 se server spust칤 a m콢쬰me se pod칤vat na nov칳 model.

Po kliknut칤 na vyhled치v치n칤 u nebude zobrazena informace o chyb캩, ale dostaneme str치nku s 0 v칳sledky.

## Nahr치n칤 z치znamu z p콏칤kazov칠 콏치dky

Pro nahr치n칤 z치znamu do repozit치콏e m콢쬰me pou쮂셦 p콏칤kazovou 콏치dku. Nejprve si nainstalujme p콏칤kaz nrp-cmd
v nov칠m okn캩 termin치lu:

```bash
python -m venv nrp-cmd-venv
source nrp-cmd-venv/bin/activate
pip install nrp-cmd
```

P콏칤kazov치 콏치dka `nrp-cmd` umo쮄갓je vytv치콏et, 캜칤st, upravovat a mazat z치znamy a soubory. Zaregistrujeme repozit치콏:

```bash
nrp-cmd add repository https://127.0.0.1:5000 --no-verify-tls myrepo
```

Nyn칤 m콢쬰me nahr치t z치znam do repozit치콏e:

```bash
nrp-cmd create record '{"title": "My first dataset"}' --community generic --set myrec

nrp-cmd get record @myrec

nrp-cmd update record @myrec '{"title": "My first dataset - updated"}'

nrp-cmd get record @myrec

nrp-cmd upload file @myrec invenio.cfg

nrp-cmd list files @myrec
```

## 칔prava modelu

Vypn캩te invenio server.

Poj캞me p콏idat do modelu pole `keywords`. Nejprve uprav칤me soubor `datasets-metadata.yaml` a p콏id치me nov칠 pole:

```yaml
  keywords[]:
    type: keyword
```

N치sledn캩 zkompilujeme model:

```bash
./nrp model compile datasets
```

Alembic migrace nen칤 pot콏eba, proto쬰 pole uvnit콏 metadat jsou ulo쬰na jako JSON a nem캩n칤 se struktura datab치zov칠 tabulky. Co se ale zm캩n칤, je struktura indexu, kter칳 je t콏eba znovu vytvo콏it:

```bash
invenio index destroy --yes-i-know
invenio index init
invenio oarepo cf init
invenio communities custom-fields init
invenio oarepo index reindex
invenio oarepo index reindex
```

Pozn치mka: na tuto sekvenci p콏칤kaz콢 bude vytvo콏en alias `./nrp reindex`.

## Vytvo콏en칤 UI pro detail z치znamu

N치sleduj칤c칤 p콏칤kaz vytvo콏칤 코ablonu UI pro detail z치znamu:

```bash
./nrp ui detail datasets
```

P콏칤kaz vytvo콏칤 soubor v `ui/datasets/templates/semantic-ui/datasets/DetailMetadata.jinja`.

### Kontrola

Spus콘te server `./nrp develop --skip-checks` a otev콏ete str치nku s detailem z치znamu
(odkaz je na `nrp-cmd read record -v @myrec`).

Pokud p콏id치te jazyk v editaci, uvid칤te, 쬰 se 코patn캩 zobrazuje. Oprava (v dal코칤 verzi gener치toru se bude takto generovat):

```jinja
<ITableField d={d.languages} level={level}>
    {% for lang in array(d.languages) %}
      <IVocabularyItem item={lang} />
    {% endfor %}
  </ITableField>
```

## 칔prava UI - p콏id치n칤 kl칤캜ov칳ch slov do deposit formul치콏e

Do formul치콏e `{model_name}/semantic-ui/js/{model_name}/forms/FormFieldsContainer.jsx`

p콏idejte na za캜치tek n치sleduj칤c칤 import:

```javascript
    import {StringArrayField} from "@js/oarepo_ui/forms"
```

a na m칤sto, kde se m치 vstup zobrazit, p콏idejte:

```javascript
   <StringArrayField
          fieldPath="metadata.keywords"
          addButtonLabel={i18next.t("Add keyword")}
          {...getFieldData({ fieldPath: "metadata.keywords" })}
    />
```

## 칔prava UI - zobrazen칤 kl칤캜ov칳ch slov ve v칳sledc칤ch vyhled치v치n칤

Do souboru `{model_name}/semantic-ui/js/{model_name}/search/ResultsListItem.jsx` p콏idejte:

*Vyta쬰n칤 hodnoty z v칳sledku vyhled치v치n칤 je mo쬹칠 pomoc칤 lodash funkce `_get`. Tato funkce bere t콏i argumenty: objekt, cestu k hodnot캩 a v칳choz칤 hodnotu, kter치 se pou쬴je, pokud cesta neexistuje.

```javascript
const keywords = _get(result, "metadata.keywords", []);

*Zobrazte kl칤캜ov치 slova v odpov칤daj칤c칤 lokaci

```javascript
{keywords.length > 0 && (
    <Grid.Row className="ui separated">
    <span
        aria-label={i18next.t("Keywords")}
        title={i18next.t("Keywords")}
    >
        {_join(
        keywords.map((keyword) => keyword),
        ", "
        )}
    </span>
    </Grid.Row>
)}
```
